<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trading Journal (Sincronizado)</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#06b6d4; --accent-2:#60a5fa; --danger:#fb7185;
      --glass: rgba(255,255,255,0.03);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0; background:linear-gradient(180deg,#071025 0%, #071a2a 100%); color:#e6eef6;}
    .container{max-width:1200px; margin:28px auto; padding:20px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .subtitle{color:var(--muted); font-size:13px}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    button{background:var(--accent);border:0;padding:8px 12px;border-radius:10px;color:#042027;cursor:pointer;font-weight:600}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent-2)}
    button.ghost{background:transparent;border:0;color:var(--muted)}
    input,select,textarea{background:var(--card);border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;color:inherit}

    .card{background:var(--card); padding:14px; border-radius:12px; box-shadow: 0 6px 20px rgba(2,6,23,0.6)}

    table{width:100%; border-collapse:collapse; font-size:13px}
    thead th{ text-align:left; padding:12px 10px; color:var(--muted); font-weight:600; font-size:12px}
    tbody td{padding:10px;border-top:1px solid rgba(255,255,255,0.02)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
    .long{width:220px}

    .flex{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .actions{display:flex;gap:8px}
    .positive{color:#10b981;font-weight:700}
    .negative{color:var(--danger);font-weight:700}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:60}
    .modal{width:100%;max-width:880px;background:linear-gradient(180deg,var(--glass), rgba(255,255,255,0.02));border-radius:12px;padding:16px}
    .form-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:900px){.form-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:600px){.form-grid{grid-template-columns:1fr}}

    footer{margin-top:14px;color:var(--muted);font-size:13px}

    .right{margin-left:auto}
    .tiny{font-size:11px;padding:6px 8px;border-radius:8px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Trading Journal (Sincronizado)</h1>
        <div class="subtitle">Registro compartido — Supabase</div>
      </div>
      <div style="margin-left:auto" class="small muted">V 2.0</div>
    </header>

    <div class="toolbar">
      <button id="newBtn">+ Nueva operación</button>
      <button id="refreshBtn" class="secondary">Refrescar</button>
      <button id="exportCSV" class="secondary">Exportar CSV</button>
      <button id="exportJSON" class="secondary">Exportar JSON</button>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <input id="filterDivisa" placeholder="Filtrar divisa (ej. XAUUSD)" />
        <input id="filterFrom" type="date" />
        <input id="filterTo" type="date" />
        <button id="clearFilters" class="ghost">Reset</button>
      </div>
    </div>

    <div class="card">
      <table id="journalTable" aria-live="polite">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Operador</th>
            <th>Divisa</th>
            <th>Cuenta</th>
            <th>Orden</th>
            <th>Lotaje</th>
            <th>Entrada</th>
            <th>Salida</th>
            <th>Beneficio Bruto</th>
            <th>Comisión</th>
            <th>Beneficio Neto</th>
            <th>%</th>
            <th class="long">Comentario</th>
            <th>Captura</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <footer>
      <br>
      Brandon Reyes
    </footer>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modal">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong id="modalTitle">Nueva operación</strong>
        <div class="actions"><button id="closeModal" class="ghost">Cerrar</button></div>
      </div>

      <form id="form">
        <div class="form-grid">
          <label>
            Operador
            <input id="operador" placeholder="Ej. Brandon" required />
          </label>
          <label>
            Fecha
            <input id="fecha" type="date" required />
          </label>
          <label>
            Divisa
            <input id="divisa" placeholder="XAUUSD" required />
          </label>

          <label>
            Tipo de cuenta
            <input id="tipo_cuenta" placeholder="Broker / Plataforma" />
          </label>
          <label>
            Tipo de orden
            <select id="tipo_orden">
              <option value="BUY">BUY</option>
              <option value="SELL">SELL</option>
            </select>
          </label>
          <label>
            Lotaje
            <input id="lotaje" type="number" step="any" placeholder="0.1" />
          </label>

          <label>
            Precio entrada
            <input id="precio_entrada" type="number" step="any" />
          </label>
          <label>
            Precio salida
            <input id="precio_salida" type="number" step="any" />
          </label>
          <label>
            Beneficio bruto
            <input id="beneficio_bruto" type="number" step="any" placeholder="Se calcula si entrada+salida+lotaje están" />
          </label>

          <label>
            Comisión
            <input id="comision" type="number" step="any" placeholder="Comisión broker" />
          </label>
          <label>
            Beneficio neto
            <input id="beneficio_neto" type="number" step="any" placeholder="Bruto - comisión (calculado automáticamente)" />
          </label>
          <label>
            Porcentaje
            <input id="porcentaje" type="number" step="any" placeholder="% (opcional)" />
          </label>

          <label style="grid-column:1/3">
            Comentario
            <textarea id="comentario" rows="2" placeholder="Notas"></textarea>
          </label>

          <label style="grid-column:3/4">
            Captura (URL)
            <input id="captura_url" placeholder="https://..." />
          </label>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button type="submit">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ---------- CONFIGURA ESTO (si prefieres, reemplaza por tus propias credenciales) ----------
    const SUPABASE_URL = "https://odunrxnrjgajnmwmzwag.supabase.co";
    const SUPABASE_KEY = "sb_publishable_0Ewu4iXl2LxOj-z_-RvgdA_6CeL-UyQ";
    // -----------------------------------------------------------------------------------------

    const supabase = supabaseJs.createClient
      ? supabaseJs.createClient(SUPABASE_URL, SUPABASE_KEY) // compat
      : supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // DOM
    const tbody = document.getElementById('tbody')
    const newBtn = document.getElementById('newBtn')
    const refreshBtn = document.getElementById('refreshBtn')
    const modal = document.getElementById('modal')
    const closeModal = document.getElementById('closeModal')
    const form = document.getElementById('form')
    const modalTitle = document.getElementById('modalTitle')

    // form fields
    const f_operador = document.getElementById('operador')
    const f_fecha = document.getElementById('fecha')
    const f_divisa = document.getElementById('divisa')
    const f_tipo_cuenta = document.getElementById('tipo_cuenta')
    const f_tipo_orden = document.getElementById('tipo_orden')
    const f_lotaje = document.getElementById('lotaje')
    const f_precio_entrada = document.getElementById('precio_entrada')
    const f_precio_salida = document.getElementById('precio_salida')
    const f_beneficio_bruto = document.getElementById('beneficio_bruto')
    const f_comision = document.getElementById('comision')
    const f_beneficio_neto = document.getElementById('beneficio_neto')
    const f_porcentaje = document.getElementById('porcentaje')
    const f_comentario = document.getElementById('comentario')
    const f_captura_url = document.getElementById('captura_url')

    const filterDivisa = document.getElementById('filterDivisa')
    const filterFrom = document.getElementById('filterFrom')
    const filterTo = document.getElementById('filterTo')
    const clearFilters = document.getElementById('clearFilters')

    let editId = null
    let operacionesCache = [] // cache local (mirror of Supabase results)

    // ---------- HELPERS ----------
    function uid(){return Date.now().toString(36) + Math.random().toString(36).slice(2,6)}
    function formatDate(val){
      if(!val) return ''
      // val expected YYYY-MM-DD
      try {
        const d = new Date(val + 'T00:00:00')
        return d.toLocaleDateString() + (d.toLocaleTimeString()? '':'')
      } catch(e){ return val }
    }
    function round(n){ return Number.isFinite(n)? Number.parseFloat(n).toFixed(2) : '' }
    function short(text,len=40){ if(!text) return ''; return text.length>len? text.slice(0,len-1)+'…': text }
    function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

    // ---------- CORE: CRUD con Supabase ----------
    async function fetchOperaciones(){
      try{
        const { data, error } = await supabase
          .from('operaciones')
          .select('*')
          .order('fecha', { ascending: false })
          .limit(1000)

        if(error) throw error
        operacionesCache = data || []
        render()
      }catch(err){
        console.error('Error fetching operaciones:', err)
        tbody.innerHTML = `<tr><td colspan="15" class="muted" style="padding:20px;text-align:center">Error cargando operaciones: ${escapeHtml(err.message || err)}</td></tr>`
      }
    }

    async function insertOperacion(obj){
      try{
        const { data, error } = await supabase
          .from('operaciones')
          .insert([obj])
          .select()
        if(error) throw error
        // no hace falta push si realtime actualiza; pero actualizamos cache inmediatamente para UX
        if(data && data[0]) operacionesCache.unshift(data[0])
        render()
      }catch(err){
        alert('Error guardando operación: ' + (err.message || err))
        console.error(err)
      }
    }

    async function updateOperacion(id, obj){
      try{
        const { data, error } = await supabase
          .from('operaciones')
          .update(obj)
          .eq('id', id)
          .select()
        if(error) throw error
        // actualizar cache
        operacionesCache = operacionesCache.map(r => r.id === id ? data[0] : r)
        render()
      }catch(err){
        alert('Error actualizando operación: ' + (err.message || err))
        console.error(err)
      }
    }

    async function deleteOperacion(id){
      if(!confirm('Eliminar esta operación?')) return
      try{
        const { error } = await supabase
          .from('operaciones')
          .delete()
          .eq('id', id)
        if(error) throw error
        operacionesCache = operacionesCache.filter(r => r.id !== id)
        render()
      }catch(err){
        alert('Error borrando operación: ' + (err.message || err))
      }
    }

    // ---------- RENDER ----------
    function render(){
      const inst = (filterDivisa.value || '').trim().toUpperCase()
      const from = filterFrom.value
      const to = filterTo.value
      tbody.innerHTML = ''
      const list = operacionesCache.filter(en=>{
        if(inst && !(en.divisa || '').toUpperCase().includes(inst)) return false
        if(from && en.fecha && (new Date(en.fecha).getTime() < new Date(from).getTime())) return false
        if(to && en.fecha && (new Date(en.fecha).getTime() > new Date(to).getTime())) return false
        return true
      })
      if(list.length===0){
        tbody.innerHTML = '<tr><td colspan="15" class="muted" style="padding:20px;text-align:center">Sin operaciones registradas</td></tr>'
        return
      }
      for(const e of list){
        const tr = document.createElement('tr')
        tr.innerHTML = `
          <td>${formatDate(e.fecha)}</td>
          <td>${escapeHtml(e.operador || '')}</td>
          <td>${escapeHtml(e.divisa || '')}</td>
          <td>${escapeHtml(e.tipo_cuenta || '')}</td>
          <td><span class="pill">${escapeHtml(e.tipo_orden || '')}</span></td>
          <td>${e.lotaje ?? ''}</td>
          <td>${e.precio_entrada ?? ''}</td>
          <td>${e.precio_salida ?? ''}</td>
          <td class="${e.beneficio_bruto!=null ? (e.beneficio_bruto>=0? 'positive':'negative') : ''}">${e.beneficio_bruto!=null? round(e.beneficio_bruto): ''}</td>
          <td>${e.comision!=null? round(e.comision): ''}</td>
          <td class="${e.beneficio_neto!=null ? (e.beneficio_neto>=0? 'positive':'negative') : ''}">${e.beneficio_neto!=null? round(e.beneficio_neto): ''}</td>
          <td>${e.porcentaje!=null? round(e.porcentaje) : ''}</td>
          <td class="long">${escapeHtml(short(e.comentario || '', 80))}</td>
          <td>${e.captura_url ? `<a href="${escapeHtml(e.captura_url)}" target="_blank" rel="noopener" class="tiny">Ver</a>` : ''}</td>
          <td style="text-align:right">
            <button class="ghost" data-id="${e.id}" onclick="edit(${e.id})">Editar</button>
            <button class="ghost" data-id="${e.id}" onclick="del(${e.id})">Borrar</button>
          </td>
        `
        tbody.appendChild(tr)
      }
    }

    // ---------- UI & modal ----------
    function openModal(edit=null){
      document.getElementById('modal').style.display = 'flex'
      if(edit){
        modalTitle.textContent = 'Editar operación'
        editId = edit.id
        f_operador.value = edit.operador || ''
        f_fecha.value = edit.fecha || ''
        f_divisa.value = edit.divisa || ''
        f_tipo_cuenta.value = edit.tipo_cuenta || ''
        f_tipo_orden.value = edit.tipo_orden || ''
        f_lotaje.value = edit.lotaje ?? ''
        f_precio_entrada.value = edit.precio_entrada ?? ''
        f_precio_salida.value = edit.precio_salida ?? ''
        f_beneficio_bruto.value = edit.beneficio_bruto ?? ''
        f_comision.value = edit.comision ?? ''
        f_beneficio_neto.value = edit.beneficio_neto ?? ''
        f_porcentaje.value = edit.porcentaje ?? ''
        f_comentario.value = edit.comentario || ''
        f_captura_url.value = edit.captura_url || ''
      } else {
        modalTitle.textContent = 'Nueva operación'
        editId = null
        form.reset()
        // default fecha = hoy
        const now = new Date()
        f_fecha.value = now.toISOString().slice(0,10)
      }
    }
    function close(){ document.getElementById('modal').style.display = 'none'; editId = null }

    newBtn.addEventListener('click', ()=>openModal())
    closeModal.addEventListener('click', close)
    modal.addEventListener('click', (e)=>{ if(e.target===modal) close() })
    refreshBtn.addEventListener('click', ()=> fetchOperaciones())

    // delete/edit helpers used in inline onclick
    window.edit = function(id){
      const en = operacionesCache.find(x=>x.id===id)
      if(en) openModal(en)
    }
    window.del = function(id){ deleteOperacion(id) }

    // ---------- FORM SUBMIT ----------
    form.addEventListener('submit', async (e)=>{
      e.preventDefault()
      // build object matching table columns (nulls = undefined)
      const obj = {
        operador: f_operador.value || null,
        fecha: f_fecha.value || null, // stored as date YYYY-MM-DD
        divisa: f_divisa.value.toUpperCase() || null,
        tipo_cuenta: f_tipo_cuenta.value || null,
        tipo_orden: f_tipo_orden.value || null,
        lotaje: f_lotaje.value ? parseFloat(f_lotaje.value) : null,
        precio_entrada: f_precio_entrada.value ? parseFloat(f_precio_entrada.value) : null,
        precio_salida: f_precio_salida.value ? parseFloat(f_precio_salida.value) : null,
        beneficio_bruto: f_beneficio_bruto.value ? parseFloat(f_beneficio_bruto.value) : null,
        comision: f_comision.value ? parseFloat(f_comision.value) : null,
        beneficio_neto: f_beneficio_neto.value ? parseFloat(f_beneficio_neto.value) : null,
        porcentaje: f_porcentaje.value ? parseFloat(f_porcentaje.value) : null,
        comentario: f_comentario.value || null,
        captura_url: f_captura_url.value || null
      }

      // If user didn't explicitly set beneficio_bruto, try to compute it if possible
      if((obj.beneficio_bruto === null || obj.beneficio_bruto === undefined) && obj.precio_entrada != null && obj.precio_salida != null && obj.lotaje != null){
        const mult = (obj.tipo_orden && obj.tipo_orden.toUpperCase()==='BUY') ? 1 : -1
        obj.beneficio_bruto = ((obj.precio_salida - obj.precio_entrada) * mult) * obj.lotaje
      }
      // compute beneficio_neto if not set and we have comision
      if((obj.beneficio_neto === null || obj.beneficio_neto === undefined) && obj.beneficio_bruto != null){
        obj.beneficio_neto = obj.beneficio_bruto - (obj.comision || 0)
      }

      if(editId){
        await updateOperacion(editId, obj)
      } else {
        await insertOperacion(obj)
      }
      close()
    })

    // ---------- FILTERS ----------
    [filterDivisa, filterFrom, filterTo].forEach(inp=>inp.addEventListener('input', render))
    clearFilters.addEventListener('click', ()=>{ filterDivisa.value=''; filterFrom.value=''; filterTo.value=''; render() })

    // ---------- EXPORT ----------
    function download(filename, text){
      const a = document.createElement('a')
      a.href = URL.createObjectURL(new Blob([text],{type:'text/plain'}))
      a.download = filename
      a.click()
      URL.revokeObjectURL(a.href)
    }
    document.getElementById('exportJSON').addEventListener('click', ()=>{
      download('trading-journal.json', JSON.stringify(operacionesCache, null, 2))
    })
    document.getElementById('exportCSV').addEventListener('click', ()=>{
      const cols = ['id','operador','fecha','divisa','tipo_cuenta','tipo_orden','lotaje','precio_entrada','precio_salida','beneficio_bruto','comision','beneficio_neto','porcentaje','comentario','captura_url']
      const rows = operacionesCache.map(e => cols.map(c => `"${(e[c] ?? '')}"`).join(','))
      download('trading-journal.csv', cols.join(',') + '\n' + rows.join('\n'))
    })

    // ---------- Real-time subscription ----------
    // This will update operacionesCache automatically when rows change
    // Using Postgres changes on table 'operaciones'
    const channel = supabase.channel('public:operaciones')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'operaciones' }, payload => {
        // payload: { eventType, schema, table, record, old_record }
        // We'll refetch for simplicity (keeps cache consistent)
        fetchOperaciones()
      })
      .subscribe()

    // ---------- Inicial load ----------
    fetchOperaciones()

    // expose for debugging
    window._sj = { supabase, fetchOperaciones, insertOperacion, updateOperacion, deleteOperacion, operacionesCache }
  </script>
</body>
</html>
