<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Trading Journal</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#06b6d4; --accent-2:#60a5fa; --danger:#fb7185;
      --glass: rgba(255,255,255,0.03);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0; background:linear-gradient(180deg,#071025 0%, #071a2a 100%); color:#e6eef6;}
    .container{max-width:1100px; margin:28px auto; padding:20px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .subtitle{color:var(--muted); font-size:13px}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    button{background:var(--accent);border:0;padding:8px 12px;border-radius:10px;color:#042027;cursor:pointer;font-weight:600}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent-2)}
    button.ghost{background:transparent;border:0;color:var(--muted)}
    input,select{background:var(--card);border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;color:inherit}

    .card{background:var(--card); padding:14px; border-radius:12px; box-shadow: 0 6px 20px rgba(2,6,23,0.6)}

    table{width:100%; border-collapse:collapse; font-size:13px}
    thead th{ text-align:left; padding:12px 10px; color:var(--muted); font-weight:600; font-size:12px}
    tbody td{padding:10px;border-top:1px solid rgba(255,255,255,0.02)}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
    .long{width:220px}

    /* responsive */
    @media (max-width:800px){
      .container{padding:12px}
      table{font-size:12px}
      .long{width:120px}
      header{flex-direction:column;align-items:flex-start}
    }

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;padding:20px}
    .modal{width:100%;max-width:720px;background:linear-gradient(180deg,var(--glass), rgba(255,255,255,0.02));border-radius:12px;padding:16px}
    .form-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media (max-width:600px){.form-grid{grid-template-columns:1fr}}

    .small{font-size:12px}
    .muted{color:var(--muted)}

    .actions{display:flex;gap:8px}

    .positive{color:#10b981;font-weight:700}
    .negative{color:var(--danger);font-weight:700}

    footer{margin-top:14px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Trading Journal</h1>
        <div class="subtitle">Registro de operaciones</div>
      </div>
      <div style="margin-left:auto" class="small muted">V 1.0</div>
    </header>

    <div class="toolbar">
      <button id="newBtn">+ Nueva operación</button>
      <button id="exportCSV" class="secondary">Exportar CSV</button>
      <button id="exportJSON" class="secondary">Exportar JSON</button>
      <button id="importJSON" class="secondary">Importar JSON</button>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <input id="filterInstrument" placeholder="Filtrar instrumento (ej. XAUUSD)" />
        <input id="filterFrom" type="date" />
        <input id="filterTo" type="date" />
        <button id="clearFilters" class="ghost">Reset</button>
      </div>
    </div>

    <div class="card">
      <table id="journalTable" aria-live="polite">
        <thead>
          <tr>
            <th>Fecha</th>
            <th class="long">Instrumento</th>
            <th>Dir</th>
            <th>Entrada</th>
            <th>Salida</th>
            <th>RR</th>
            <th>Gan/Per</th>
            <th>Notas</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <footer>
      <br>
      Brandon Reyes
    </footer>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modal">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong id="modalTitle">Nueva operación</strong>
        <div class="actions"><button id="closeModal" class="ghost">Cerrar</button></div>
      </div>

      <form id="form">
        <div class="form-grid">
          <label>
            Fecha
            <input id="date" type="datetime-local" required />
          </label>
          <label>
            Instrumento
            <input id="instrument" placeholder="ej. XAUUSD" required />
          </label>

          <label>
            Dirección
            <select id="direction"><option value="Long">Long</option><option value="Short">Short</option></select>
          </label>

          <label>
            Tamaño/Contratos
            <input id="size" type="number" step="any" placeholder="ej. 0.1" />
          </label>

          <label>
            Precio Entrada
            <input id="entry" type="number" step="any" required />
          </label>

          <label>
            Precio Salida
            <input id="exit" type="number" step="any" />
          </label>

          <label>
            Riesgo:Recompensa (RR)
            <input id="rr" placeholder="ej. 1:2" />
          </label>

          <label style="grid-column:1/3">
            Notas
            <input id="notes" placeholder="Breve nota / idea" />
          </label>
        </div>

        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
          <button type="submit">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <input id="fileInput" type="file" accept="application/json" style="display:none" />

  <script>
    // Simple trading journal with localStorage persistence
    const STORAGE_KEY = 'trading-journal-v1'
    let entries = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]')

    // DOM
    const tbody = document.getElementById('tbody')
    const newBtn = document.getElementById('newBtn')
    const modal = document.getElementById('modal')
    const closeModal = document.getElementById('closeModal')
    const form = document.getElementById('form')
    const modalTitle = document.getElementById('modalTitle')
    const fileInput = document.getElementById('fileInput')

    const filterInstrument = document.getElementById('filterInstrument')
    const filterFrom = document.getElementById('filterFrom')
    const filterTo = document.getElementById('filterTo')
    const clearFilters = document.getElementById('clearFilters')

    let editId = null

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(entries))
      render()
    }

    function uid(){return Date.now().toString(36) + Math.random().toString(36).slice(2,6)}

    function openModal(edit=null){
      modal.style.display='flex'
      if(edit){
        modalTitle.textContent='Editar operación'
        editId = edit.id
        document.getElementById('date').value = edit.date
        document.getElementById('instrument').value = edit.instrument
        document.getElementById('direction').value = edit.direction
        document.getElementById('size').value = edit.size || ''
        document.getElementById('entry').value = edit.entry || ''
        document.getElementById('exit').value = edit.exit || ''
        document.getElementById('rr').value = edit.rr || ''
        document.getElementById('notes').value = edit.notes || ''
      } else {
        modalTitle.textContent='Nueva operación'
        editId = null
        form.reset()
        // default to now in local datetime format
        const now = new Date()
        const offset = now.getTimezoneOffset()
        const local = new Date(now.getTime() - offset*60000).toISOString().slice(0,16)
        document.getElementById('date').value = local
      }
    }

    function close(){ modal.style.display='none'; editId=null }

    newBtn.addEventListener('click', ()=>openModal())
    closeModal.addEventListener('click', close)
    modal.addEventListener('click', (e)=>{ if(e.target===modal) close() })

    form.addEventListener('submit', (e)=>{
      e.preventDefault()
      const obj = {
        id: editId || uid(),
        date: document.getElementById('date').value,
        instrument: document.getElementById('instrument').value.toUpperCase(),
        direction: document.getElementById('direction').value,
        size: document.getElementById('size').value,
        entry: document.getElementById('entry').value,
        exit: document.getElementById('exit').value,
        rr: document.getElementById('rr').value,
        notes: document.getElementById('notes').value
      }
      // compute pnl simple
      if(obj.entry && obj.exit){
        const mult = obj.direction==='Long'? 1 : -1
        obj.pnl = ((parseFloat(obj.exit)-parseFloat(obj.entry)) * mult) * (parseFloat(obj.size) || 1)
      } else obj.pnl = null

      if(editId){
        entries = entries.map(en => en.id===editId? obj : en)
      } else entries.unshift(obj)
      save()
      close()
    })

    function render(){
      // apply filters
      const inst = filterInstrument.value.trim().toUpperCase()
      const from = filterFrom.value
      const to = filterTo.value
      tbody.innerHTML = ''
      const list = entries.filter(en=>{
        if(inst && !en.instrument.includes(inst)) return false
        if(from && en.date < from) return false
        if(to && en.date > (to + 'T23:59')) return false
        return true
      })
      if(list.length===0){
        tbody.innerHTML = '<tr><td colspan="9" class="muted" style="padding:20px;text-align:center">Sin operaciones registradas</td></tr>'
        return
      }
      for(const e of list){
        const tr = document.createElement('tr')
        tr.innerHTML = `
          <td>${formatDate(e.date)}</td>
          <td class="long">${escapeHtml(e.instrument)}</td>
          <td><span class="pill">${e.direction}</span></td>
          <td>${e.entry || ''}</td>
          <td>${e.exit || ''}</td>
          <td>${e.rr || ''}</td>
          <td class="${e.pnl!=null ? (e.pnl>=0? 'positive':'negative') : ''}">${e.pnl!=null? round(e.pnl): ''}</td>
          <td>${escapeHtml(short(e.notes,40))}</td>
          <td style="text-align:right">
            <button class="ghost" data-id="${e.id}" onclick="edit('${e.id}')">Editar</button>
            <button class="ghost" data-id="${e.id}" onclick="del('${e.id}')">Borrar</button>
          </td>
        `
        tbody.appendChild(tr)
      }
    }

    // utility functions available in global scope for inline onclick
    window.edit = function(id){
      const en = entries.find(x=>x.id===id)
      if(en) openModal(en)
    }
    window.del = function(id){
      if(!confirm('Eliminar esta operación?')) return
      entries = entries.filter(e=>e.id!==id)
      save()
    }

    function formatDate(val){
      if(!val) return ''
      const d = new Date(val)
      if(isNaN(d)) return val
      return d.toLocaleString()
    }
    function short(text,len=30){ if(!text) return ''; return text.length>len? text.slice(0,len-1)+'…': text }
    function round(n){ return Number.parseFloat(n).toFixed(2) }
    function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

    function download(filename, text){
      const a = document.createElement('a')
      a.href = URL.createObjectURL(new Blob([text],{type:'text/plain'}))
      a.download = filename
      a.click()
      URL.revokeObjectURL(a.href)
    }

    document.getElementById('exportJSON').addEventListener('click', ()=>{
      download('trading-journal.json', JSON.stringify(entries, null, 2))
    })

    document.getElementById('exportCSV').addEventListener('click', ()=>{
      const cols = ['id','date','instrument','direction','size','entry','exit','rr','pnl','notes']
      const rows = entries.map(e => cols.map(c => '"'+(e[c]??'')+'"').join(','))
      download('trading-journal.csv', cols.join(',') + '\n' + rows.join('\n'))
    })

    document.getElementById('importJSON').addEventListener('click', ()=> fileInput.click())

    fileInput.addEventListener('change', async (ev)=>{
      const f = ev.target.files[0]
      if(!f) return
      try{
        const txt = await f.text()
        const parsed = JSON.parse(txt)
        if(!Array.isArray(parsed)) throw new Error('JSON debe ser un array de entradas')
        // merge but avoid duplicates by id
        const map = new Map(entries.map(e=>[e.id,e]))
        for(const p of parsed){ if(p.id && !map.has(p.id)) map.set(p.id,p) }
        entries = Array.from(map.values()).sort((a,b)=> (b.date||'') > (a.date||'') ? 1:-1)
        save()
        fileInput.value=''
        alert('Importado correctamente')
      }catch(err){ alert('Error al importar: '+err.message) }
    })

    // filters
    [filterInstrument, filterFrom, filterTo].forEach(inp=>inp.addEventListener('input', render))
    clearFilters.addEventListener('click', ()=>{ filterInstrument.value=''; filterFrom.value=''; filterTo.value=''; render() })

    // initial render
    render()

    // expose save to window for debugging
    window._journal = {entries, save}

  </script>
</body>

</html>

