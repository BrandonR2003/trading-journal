<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Trading Journal</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body{font-family:Arial,sans-serif;background:#121212;color:white;margin:0;padding:20px;}
  .container{max-width:900px;margin:auto;background:#1e1e1e;padding:20px;border-radius:8px;}
  input, select, textarea{width:100%;padding:8px;margin:6px 0;border-radius:4px;border:none;color:black;}
  button{padding:10px;width:100%;background:#4caf50;border:none;color:white;font-size:16px;border-radius:5px;cursor:pointer;}
  table{width:100%;border-collapse:collapse;margin-top:25px;}
  th, td{border:1px solid #333;padding:8px;text-align:center;}
  th{background:#333;}
  .example{color:#ccc;font-size:12px;margin-top:-6px;margin-bottom:6px;}
</style>
</head>
<body>
<div class="container">
  <h1>Trading Journal</h1>

  <button id="newBtn">+ Nueva operación</button>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>ID</th><th>Operador</th><th>Fecha</th><th>Divisa</th>
          <th>Tipo Cuenta</th><th>Orden</th><th>Lotaje</th>
          <th>Entrada</th><th>Salida</th><th>Bruto</th>
          <th>Comisión</th><th>Neto</th><th>%</th>
          <th>Comentario</th><th>Captura</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);align-items:center;justify-content:center;">
  <div style="background:#222;padding:16px;border-radius:12px;width:100%;max-width:600px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>Nueva operación</strong>
      <button id="closeModal" style="background:none;border:none;color:#ccc;cursor:pointer;">Cerrar</button>
    </div>
    <form id="form">
      <label>Operador
        <select id="operador" required>
          <option value="">Selecciona operador</option>
          <option value="Brandon">Brandon</option>
          <option value="Raul">Raul</option>
        </select>
      </label>

      <label>Fecha
        <input id="fecha" type="date" required>
      </label>

      <label>Divisa
        <select id="divisa" required>
          <option value="">Selecciona divisa</option>
          <option value="EUR/USD">EUR/USD</option>
          <option value="GBP/USD">GBP/USD</option>
          <option value="USD/JPY">USD/JPY</option>
          <option value="XAU/USD">XAU/USD</option>
        </select>
      </label>

      <label>Tipo Cuenta
        <select id="tipo_cuenta" required>
          <option value="">Selecciona tipo</option>
          <option value="Apollo">Apollo</option>
          <option value="Personal">Personal</option>
        </select>
      </label>

      <label>Tipo Orden
        <select id="tipo_orden">
          <option value="Buy">Buy</option>
          <option value="Sell">Sell</option>
        </select>
      </label>

      <label>Precio Entrada
        <input id="precio_entrada" type="text" required>
        <div class="example" id="ejemploEntrada"></div>
      </label>

      <label>Precio Salida
        <input id="precio_salida" type="text" required>
        <div class="example" id="ejemploSalida"></div>
      </label>

      <div style="margin-top:10px;">
        <button type="submit">Guardar Operación</button>
      </div>
    </form>
  </div>
</div>

<script>
  // --- Supabase ---
  const SUPABASE_URL = "https://odunrxnrjgajnmwmzwag.supabase.co";
  const SUPABASE_KEY = "sb_publishable_0Ewu4iXl2LxOj-z_-RvgdA_6CeL-UyQ";
  const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const newBtn = document.getElementById('newBtn');
  const modal = document.getElementById('modal');
  const closeModal = document.getElementById('closeModal');
  const form = document.getElementById('form');
  const tbody = document.getElementById('tbody');

  const divisaSelect = document.getElementById('divisa');
  const precioEntrada = document.getElementById('precio_entrada');
  const precioSalida = document.getElementById('precio_salida');
  const ejemploEntrada = document.getElementById('ejemploEntrada');
  const ejemploSalida = document.getElementById('ejemploSalida');

  // Abrir/Cerrar modal
  newBtn.addEventListener('click', ()=>{ modal.style.display='flex'; form.reset(); resetEjemplo(); });
  closeModal.addEventListener('click', ()=> modal.style.display='none');
  modal.addEventListener('click', e=>{ if(e.target===modal) modal.style.display='none'; });

  // Ejemplos y decimales por divisa
  const ejemploPorDivisa = {
    'EUR/USD': {ej:'1.15364', dec:5},
    'GBP/USD': {ej:'1.30875', dec:5},
    'USD/JPY': {ej:'145.432', dec:3},
    'XAU/USD': {ej:'4016.98', dec:2}
  };

  function resetEjemplo(){
    ejemploEntrada.textContent = '';
    ejemploSalida.textContent = '';
    precioEntrada.value = '';
    precioSalida.value = '';
  }

  function actualizarEjemplo(){
    const div = divisaSelect.value;
    if(ejemploPorDivisa[div]){
      const {ej, dec} = ejemploPorDivisa[div];
      ejemploEntrada.textContent = 'ej. '+ej;
      ejemploSalida.textContent = 'ej. '+ej;
      precioEntrada.dataset.dec = dec;
      precioSalida.dataset.dec = dec;
    } else {
      ejemploEntrada.textContent = '';
      ejemploSalida.textContent = '';
      precioEntrada.dataset.dec = '';
      precioSalida.dataset.dec = '';
    }
  }

  divisaSelect.addEventListener('change', ()=>{
    actualizarEjemplo();
    precioEntrada.value='';
    precioSalida.value='';
  });

  // Bloquear decimales mientras escribe
  function limitarInput(input){
    input.addEventListener('input', ()=>{
      const dec = parseInt(input.dataset.dec||0);
      if(!dec) return;
      let val = input.value;
      if(val.includes('.')){
        let [entero, decimal] = val.split('.');
        decimal = decimal.slice(0, dec);
        input.value = entero + (decimal ? '.'+decimal : '');
      }
    });
  }
  limitarInput(precioEntrada);
  limitarInput(precioSalida);

  // Cargar operaciones
  async function cargarOperaciones(){
    const {data, error} = await db.from('operaciones').select('*').order('id',{ascending:false});
    if(error){ alert("Error cargando: "+error.message); return; }
    tbody.innerHTML = '';
    if(data.length===0){ tbody.innerHTML='<tr><td colspan="15" style="text-align:center;color:#ccc;">Sin operaciones registradas</td></tr>'; return; }
    data.forEach(op=>{
      // Formatear fecha a dd/mm/yyyy
      let fecha = op.fecha ? new Date(op.fecha) : null;
      let fechaStr = fecha ? `${('0'+fecha.getDate()).slice(-2)}/${('0'+(fecha.getMonth()+1)).slice(-2)}/${fecha.getFullYear()}` : '';
      tbody.innerHTML += `<tr>
        <td>${op.id}</td>
        <td>${op.operador||''}</td>
        <td>${fechaStr}</td>
        <td>${op.divisa||''}</td>
        <td>${op.tipo_cuenta||''}</td>
        <td>${op.tipo_orden||''}</td>
        <td>${op.lotaje||''}</td>
        <td>${op.precio_entrada||''}</td>
        <td>${op.precio_salida||''}</td>
        <td>${op.beneficio_bruto||''}</td>
        <td>${op.comision||''}</td>
        <td>${op.beneficio_neto||''}</td>
        <td>${op.porcentaje||''}</td>
        <td>${op.comentario||''}</td>
        <td><a href="${op.captura_url}" target="_blank">Ver</a></td>
      </tr>`;
    });
  }

  // Guardar operación con validación de decimales exactos
  form.addEventListener('submit', async e=>{
    e.preventDefault();
    const dec = parseInt(precioEntrada.dataset.dec||0);
    const regex = new RegExp(`^\\d+(\\.\\d{${dec}})$`); // exactos decimales

    if(!regex.test(precioEntrada.value)){
      alert(`Precio Entrada debe tener exactamente ${dec} decimales`);
      return;
    }
    if(!regex.test(precioSalida.value)){
      alert(`Precio Salida debe tener exactamente ${dec} decimales`);
      return;
    }

    const data = {
      operador: document.getElementById("operador").value,
      fecha: document.getElementById("fecha").value,
      divisa: divisaSelect.value,
      tipo_cuenta: document.getElementById("tipo_cuenta").value,
      tipo_orden: document.getElementById("tipo_orden").value,
      precio_entrada: precioEntrada.value,
      precio_salida: precioSalida.value
    };

    const {error} = await db.from('operaciones').insert(data);
    if(error){ alert("Error guardando: "+error.message); return; }
    modal.style.display='none';
    cargarOperaciones();
  });

  cargarOperaciones();
</script>
</body>
</html>
